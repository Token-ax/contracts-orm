import React from 'react'
import View from './View.js'

import { w3, contractws } from '../../helpers/Web3Helper'
function zip(arr1, arr2, out = {}) {
  arr1.map((val, idx) => {
    out[val] = arr2[idx]
  })
  return out
}

const blendstyle = {
  color: 'white',
}

export default class PublicMessages extends React.Component {
  constructor(props) {
    super(props)
    this.state = {
      publicMessages: {
        data: [],
        loaded:false
      },
    }
  }

  async setUpListeners() {
    var that = this
    contractws.events.allEvents(
      'allEvents',
      {
        fromBlock: 'latest',
      },
      async function (err, data) {
        await that.fetch()
      },
    )
  }

  async fetch() {
    const response = await this.getPublicMessages()
    this.setState({ publicMessages: { data: response,loaded:true } })
  }

  async componentDidMount() {
    await this.fetch()
    await this.setUpListeners()
  }

  async getPublicMessages() {
    var messages_count = await contractws.methods
      .get_{{contract
}}_list_length()
      .call()
      if(messages_count == 0 ){
        return []
      }
      const COUNT = 20
      const count = Math.min(COUNT, messages_count);
      const offset = Math.max(0,messages_count - count)
      let ret = []
   
      var messages = await contractws.methods.get_last_{{contract
}}_N(count,offset).call()
      for(var i = messages[0].length-1; i>-1 ; i--){
        var value = []
        for(var key in messages){
          value.push(messages[key][i])
        }
        value.push(i)
        var keys = []
{{#each contract_data.readRules.gets}}
  keys.push(`{{this}}`)
{{/each}}
keys.push(`id`)
        var msg = zip(keys,value)

        ret.push(msg)
      }
     
    return ret
  }

  render() {
    if (this.state.publicMessages.data.length == 0) {
      if(this.state.publicMessages.loaded){
        return (

<div>
  <span className='sr-only'>
    No {{contract}} yet
  </span>
</div>

)
      }
      return (
<div>
  <span className='sr-only'>
    Loading...
  </span>
</div>
)
    }

    return (
<div>
  {this.state.publicMessages.data.map((data, index) => (
  <View key={data.id} data={data} />
  ))}
</div>
)
  }
}